# TrajectoryPlanning
## 2025/9/27
>天开始正式学习复现一篇轨迹优化的论文[Convergence-Guaranteed Trajectory Planning for a Class of Nonlinear Systems With Nonconvex State Constraints](https://ieeexplore.ieee.org/document/9627774/)
- 这篇论文的设计是非线性动力学系统的非凸优化问题，使用了Lossless Convex方法。文章将问题尽可能得简化了：
    - 研究问题为车辆的二维轨迹优化
    - 文章对heading角的约束是$\|theta|\le\frac{\pi}{2}$,这意味着车辆不能回头开
    - 控制输入也被简化了，文章假设车是匀速行驶的，因此没有加速度这一控制量
- 顺便看了一下动态规划的概念，感觉这个想法很好啊，就是为什么总是会收敛到最优路径有点难以理解
## 2025/10/1
### Problem R(松弛问题):
$$
\begin{align*}
\text{Problem } \mathcal{R}:\quad \min_{u} \quad & J = \varphi(z(t_f), t_f) + \int_{t_0}^{t_f} \ell(z, u, t)  dt \\
\text{s.t.} \quad & \dot{z} = A z + B u, \quad z(t_0) = z_0 \quad \text{(线性约束:包含后两个)}\\
& u_2 \geq -w_{\max} u_1 \\
& u_2 \leq w_{\max} u_1 \\
& (u_1)^2 + (z_3)^2 \leq 1\quad\text{(混合约束)}\\
& g^c(x, y) \leq 0 \quad \text{(凸状态约束)}\\
& g^{nc}(x, y) \leq 0 \quad \text{(非凸状态约束)}\\
& \phi(z(t_f)) \leq 0 \quad \text{(末端约束)}
\end{align*}
$$
#### 其中 ：
$$
\begin{align*}
z &= [z_1\ z_2\ z_3]^T := [x\ y\ \theta_s]^T \\
u &= [u_1\ u_2]^T := [\theta_c\ \theta_d]^T \\
A &= \begin{bmatrix}
0 & 0 & 0 \\
0 & 0 & v \\
0 & 0 & 0 
\end{bmatrix}, \quad 
B = \begin{bmatrix}
v & 0 \\
0 & 0 \\
0 & 1 
\end{bmatrix}
\end{align*}
$$

### Problem D(离散问题):
$$
\begin{align*}
\text{Problem } \mathcal{D}:\quad \min_{\chi} \quad & c^T \chi \\
\text{s.t.} \quad & H \chi \leq q \quad \text{(线性约束)}\\
& g^{nc}(x_i, y_i) \leq 0, \quad i = 0, \ldots, N \quad \text{(非凸状态约束)}\\
& \Lambda \chi - b \geq_K 0\quad \text{(松弛约束)}
\end{align*}
$$
#### 其中：
$$
\begin{align*}
& \text{离散化变量：} z_i = [x_i\ y_i\ \theta_{s,i}]^T, \quad u_i = [\theta_{c,i}\ \theta_{d,i}]^T \\
& \text{目标函数：} J = k_1|x_N - x_f| + k_2|y_N - y_f| + k_3 \sum_{i=0}^N \Delta t (y_i - y_{c,i})^2 \\
& \text{优化变量：} \chi \text{ 包含 } \{z_i; u_i\}_{i=0,\ldots,N}\\
&\text{及所有必要辅助变量: }\Delta t = \frac{t_f - t_0}{N}
\end{align*}
$$

## 2025/10/4
### 迭代？
不太理解$g^{nc}(x^k_i,y^k_i)$的迭代方式，为什么是对k进行迭代而不是对i进行迭代呢？


## 2025/10/10
### todebug
- 缺少对cosine的正性约束
- 需修改收敛检查条件，不应该只是检查终端精度，这取决于离散化方法带来的数值精度；而应该是检查整个轨迹的变化
- 最后一个点没有做到u1^2+z3^2为1
### todo 
- 添加approach cone约束
- 记录求解时间变量
- plot_all需要添加heading angle和Angular velocity的绘图代码
### have done
- 收敛条件修改
- 记录求解时间
- 我发现，最后一个点没做到无所谓，不改了
- 仔细阅读论文后发现，cosine的正性约束已经在目标函数中被隐式保证了，不需要添加
- 添加了approach cone的约束
- 修改了plot_all的代码

## 2025/10/11
- 发现一个问题，初始轨迹的猜测可以穿过障碍物，最后的结果还是收敛的，但是也不能太离谱，我选取了从起点到终点的直线，但是第一次迭代就不可行了；那么什么样的轨迹猜测是合适的呢
- A的复现告一段落，现在开始复现B
### todo
- initialize_trajectory写得太烂了，用matlab内置函数重新写一下
### problem
- 遇到了一个奇妙问题：
> 在LaneChange中，如果是无障碍物的情况，第一次迭代就失败,但是把w_max改一下也能顺利跑通
> 如果是有障碍物的情况，第一次迭代成功但是第二次迭代失败，报错为经典的LOGIC FALSE

## 2025/10/12
- 正在调试和修改bug
> optimize函数返回的problem指示是 numerical problems ，官网给了一堆车轱辘建议

- 发现一个逆天的事情：
  - constraints=[constraints,Wmax*u(:,i)<=0];%|u2|<=wmax*|u1|
  
  - constraints=[constraints, -params.w_max_rad*u(1,i)-u(2,i)<=0];
    constraints=[constraints, -params.w_max_rad*u(1,i)+u(2,i)<=0];
这两个数学上完全等价的东西，前者完全跑不出来，而后者却可以很好的运行？？？？
> 很有可能是ECOS内部对约束处理的微小差异，这侧面反映了我的代码存在很大问题，因为数值是不稳定的


- a few moments later
- 差不多知道了原因，是因为我的离散化方法和论文不太一样，我一开始使用的是ZOH零阶保持，在使用了欧拉前向差分 (Euler Forward Discretization)后能够成功复现w_max=15[deg/s]的情况了
- 问题的本质还没有找到，11号的问题仍然存在

